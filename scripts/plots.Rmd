---
title: "Plot MH questions"
output:
  html_notebook:
    css: "style.css"
---

```{r setup}
knitr::opts_chunk$set(
  echo = FALSE,
  dev = "svg"
)

knitr::opts_knit$set(
  progress = FALSE,
  verbose = FALSE
)
```

```{r message=FALSE}
library(tidyverse)
library(setmeup)
```

```{r include=FALSE}
lapply(list.files(pattern = "^fn"), source)
```

```{r}
mhsurv <- readRDS("../data/2-final/mh_survey_results.rds")
cb <- readRDS("../data/2-final/mh_codebook.rds")
```

```{r}
mhsmry <- summarize_dataset()
```

```{r}
mhfigs <- imap(mhsmry, \(df, x) plot_data(df, x))
names(mhfigs) <- names(mhsmry)
```

```{r}
# Histogram for `slp_lat`
df <- mhsurv |>
  drop_na(slp_lat)

p <- df |>
  ggplot(aes(x = slp_lat)) +
  geom_bar(fill = "#4f0a6b") +
  scale_x_binned(
    breaks = seq(0, 180, 5),
    expand = c(0, NA)
  ) +
  scale_y_continuous(
    breaks = seq(0, 140, 20),
    expand = c(0, NA)
  ) +
  labs(x = "\nSleep latency (minutes)", y = "Number of responses\n") +
  theme_classic() +
  theme(
    plot.background = element_rect(fill = NA, color = NA),
    panel.background = element_rect(fill = NA, color = NA),
    axis.line = element_line(color = "#555555"),
    axis.ticks = element_line(color = "#555555"),
    plot.margin = margin(t = 50, b = 50, r = 20, l = 20)
  )

cap <- paste0("N = ", nrow(df), ".")

mhfigs$slp_lat <- list(plot = p, cap = cap)
```

```{r results='asis'}
for (i in 1:length(mhfigs)) {
  q <- gsub("_", "-", names(mhfigs)[i])
  nm <- paste0("fig-", q)
  h <- ifelse(grepl("q11", q), 10, 6)
  
  chunk <- sprintf(
    "```{r %s, fig.height=%s, fig.width=10}
    print(
      mhfigs[[i]]$plot |>
        add_caption(mhfigs[[i]]$cap, size = 15, width = 110)
    )
    ```",
    nm, h
  )

  print_md_text(paste("##", toupper(q)))
  print_md_chunk(chunk)
}
```

```{r}
saveRDS(mhfigs, "../data/2-final/figures_ungrouped.rds")
```
