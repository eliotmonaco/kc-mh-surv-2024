---
title: "Plot selected questions grouped by age"
output: html_notebook
---

```{r message=FALSE}
library(tidyverse)
library(setmeup)
```

```{r include=FALSE}
lapply(list.files(pattern = "^fn"), source)
```

```{r}
mhsurv <- readRDS("../data/2-final/mh_survey_results.rds")
cb <- readRDS("../data/2-final/mh_codebook.rds")
```

```{r}
vars <- c("si_bin", "sm_use_bin", "hse")

mhsmry <- lapply(vars, \(x) {
  summarize_results(mhsurv, var = x, gp_fctr = "age2")
})

names(mhsmry) <- vars
```

```{r}
mhfigs <- imap(mhsmry, \(df, x) {
  n <- ifelse(x == "hse", 0, 5)

  p <- df |>
    rename(age = age2) |>
    plot_grouped_data(x, "age", n_repel = n, dir = "v")

  if (x == "hse") {
    p <- p +
      coord_cartesian(ylim = c(90, 100)) +
      scale_y_continuous(
        expand = c(0, NA),
        breaks = c(90, 95, 100)
      ) +
      geom_text(
        aes(label = ifelse(
          df$hse == "No difficulty",
          paste0(round_ties_away(df$pct), "%"),
          NA
        )),
        position = position_nudge(y = -((df$pct - 90) / 2)),
        color = "white",
        fontface = "bold"
      )
  }

  p
})

names(mhfigs) <- paste0(vars, "_age")

mhcaps <- imap(mhsmry, \(df, x) {
  cap <- cap_text(df, x)
  
  if (x == "hse") {
    cap <- paste(cap, "Note the truncated y-axis scale.")
  }
  
  cap
})

names(mhcaps) <- paste0(vars, "_age")
```

```{r fig.width=7, fig.height=4.5}
mhfigs$si_bin_age
```

```{r fig.width=7, fig.height=4.5}
mhfigs$sm_use_bin_age
```

```{r fig.width=7, fig.height=4.5}
mhfigs$hse_age
```

# Save/export

```{r include=FALSE}
imap(mhfigs, \(x, i) {
  i <- gsub("_", "-", i)
  ggsave(
    paste0("mh-report/img/", i, ".png"), x,
    width = 7, height = 4.5, dpi = 100
  )
})
```

```{r}
saveRDS(mhcaps, "../data/2-final/figure_captions_questions_by_age.rds")
```
