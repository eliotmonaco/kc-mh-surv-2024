---
title: "Survey sample characteristics"
output:
  html_notebook:
    css: "style.css"
---

# Purpose

Summarize the demographic and geographic characteristics of the Mental Health Survey sample, and compare the demographic and geographic profile of the survey sample to census population estimates for Kansas City.

# Set up environment and import data

```{r setup}
knitr::opts_chunk$set(
  dev = "svg"
)

knitr::opts_knit$set(
  progress = FALSE,
  verbose = FALSE
)
```

```{r message=FALSE}
library(tidyverse)
library(readxl)
library(kcData)
library(setmeup)
library(sf)
```

```{r}
source("fn.R")
```

```{r}
mhsurv <- readRDS("../data/2-final/mh_survey_results.rds")
cb <- readRDS("../data/2-final/mh_codebook.rds")
hoi_regions <- st_read("../data/1-source/hoi_regions.shp", quiet = TRUE)
```

# Prep data

# Analysis

The survey was completed by 648 residents. Citywide population estimates were taken from the 2023 5-Year American Community Survey conducted by the US Census Bureau.

```{r}
mhsmry <- list()
kcpop <- list()
```

## Summarize

### Birth sex

Summarize the survey sample by sex.

```{r}
df <- mhsurv |>
  summarize_results(var = "birth_sex", na_rm = TRUE)
```

Pull the ACS population estimates by sex for Kansas City.

```{r}
kcpop$total <- acs5_city_2023$estimate[acs5_city_2023$variable == "B01001_001"]

kcpop$sex <- acs5_city_2023 |>
  filter(variable %in% c("B01001_002", "B01001_026")) |>
  mutate(kc_total = kcpop$total)
```

Find the percentage of each sex category in KC sampled.

```{r}
mhsmry$birth_sex <- df |>
  left_join(
    kcpop$sex |>
      select(label, estimate, kc_total) |>
      mutate(label = str_remove_all(label, "Estimate|Total|[:punct:]")),
    by = c("birth_sex" = "label"),
    keep = TRUE # keeps `birth_sex` as factor
  ) |>
  select(-label) |>
  mutate(pct_kc = pct(estimate, kc_total, 5))

mhsmry$birth_sex
```

### Age

Summarize the survey sample by age.

```{r}
df <- mhsurv |>
  summarize_results(var = "age1", na_rm = TRUE)
```

Pull the ACS population estimates by age for Kansas City.

```{r}
kcpop$age <- acs5_city_2023 |>
  filter(
    str_detect(label, paste0("(", paste(18:100, collapse = "|"), ").*years")),
    concept == "Sex by Age"
  ) |>
  mutate(kc_total = kcpop$total)
```

Summarize ACS estimates by the same age categories in the survey sample.

```{r}
kcpop$age <- kcpop$age |>
  select(label, estimate, kc_total) |>
  mutate(label = str_remove_all(label, "Estimate|Total|[:punct:]")) |>
  mutate(
    sex = str_extract(label, "^[:alpha:]+(?=\\d)"),
    age_group = str_extract(label, "\\d.*") |>
      str_remove("\\syears.*")
  )

rng <- list(18:34, 35:44, 45:54, 55:64, 65:74, 75:85)

kcpop$age <- data.frame(
  age = cb$age1$value,
  estimate = unlist(lapply(rng, \(x) {
    kcpop$age |>
      filter(str_detect(age_group, paste(x, collapse = "|"))) |>
      pull(estimate) |>
      sum()
  })),
  kc_total = unique(kcpop$age$kc_total)
)
```

Find the percentage of each age category in KC sampled.

```{r}
mhsmry$age <- df |>
  rename(age = age1) |>
  left_join(
    kcpop$age,
    by = "age"
  ) |>
  mutate(pct_kc = pct(estimate, kc_total, 5))

mhsmry$age
```

### Race/ethnicity

#### All categories

Summarize the survey sample by all race/ethnicity options.

```{r}
# Get total number of responses
t <- sum(!is.na(mhsurv$re_abbr))

# Split multiple selections into separate columns
df <- mhsurv |>
  select(re_abbr) |>
  separate_wider_delim(
    re_abbr,
    delim = "; ",
    names_sep = "_",
    too_few = "align_start"
  )

# Stack columns and summarize
df <- df |>
  stack(select = colnames(df)) |>
  select(race_ethnicity = values) |>
  drop_na() |>
  count(race_ethnicity, .drop = FALSE) |>
  mutate(total = t) |>
  mutate(pct = pct(n, total, 5))
```

```{r}
# Convert to factor sorted by size
lvl <- df |>
  arrange(pct) |>
  pull(race_ethnicity)

mhsmry$race_ethnicity <- df |>
  mutate(race_ethnicity = factor(race_ethnicity, levels = lvl))

mhsmry$race_ethnicity
```

Summarize the write-in responses for "Other".

```{r}
mhsurv |>
  count(re_other, .drop = FALSE)
```

#### Collapsed categories

Summarize the survey sample by collapsed race/ethnicity categories.

```{r}
df <- mhsurv |>
  summarize_results(var = "re_bwo", na_rm = TRUE)
```

```{r}
# Convert to factor sorted by size
lvl <- df |>
  arrange(pct) |>
  pull(re_bwo)

df <- df |>
  mutate(re_bwo = factor(re_bwo, levels = lvl))
```

Pull the ACS population estimates by race for Kansas City.

```{r}
kcpop$race <- acs5_city_2023 |>
  filter(grepl("B01001[A-G]_001", variable)) |>
  mutate(kc_total = kcpop$total)
```

Verify that the sum of estimates by race equals the total population estimate.

```{r}
identical(
  kcpop$race |>
    pull(estimate) |>
    sum(),
  acs5_city_2023 |>
    filter(grepl("B01001_001", variable)) |>
    pull(estimate)
)
```

Summarize the ACS population estimates by the collapsed race/ethnicity categories.

```{r}
kcpop$race_bwo <- data.frame(
  race = c("Black", "White", "Other"),
  estimate = c(
    kcpop$race$estimate[grepl("Black", kcpop$race$concept)],
    kcpop$race$estimate[grepl("White", kcpop$race$concept)],
    sum(kcpop$race$estimate[!grepl("Black|White", kcpop$race$concept)])
  ),
  kc_total = kcpop$total
)
```

Find the percentage of each collapsed race/ethnicity category in KC sampled.

```{r}
mhsmry$race_collapsed <- df |>
  left_join(
    kcpop$race_bwo,
    by = c("re_bwo" = "race"),
    keep = TRUE # keeps `re_bwo` as factor
  ) |>
  select(-race) |>
  mutate(pct_kc = pct(estimate, kc_total, 5)) |>
  rename(race_collapsed = re_bwo)

mhsmry$race_collapsed
```

### Hispanic origin

Summarize the survey sample by Hispanic origin.

```{r}
df <- mhsurv |>
  summarize_results(var = "hispanic_origin", na_rm = TRUE)
```

Pull the ACS population estimates by Hispanic origin for Kansas City.

```{r}
kcpop$hispanic <- acs5_city_2023 |>
  filter(grepl("B01001I?_001", variable)) |>
  mutate(kc_total = kcpop$total)
```

Summarize the ACS population estimates by Hispanic origin.

```{r}
kcpop$hispanic <- data.frame(
  hispanic_origin_acs = c("Hispanic", "Not Hispanic"),
  estimate = c(
    kcpop$hispanic$estimate[kcpop$hispanic$variable == "B01001I_001"],
    kcpop$hispanic$estimate[kcpop$hispanic$variable == "B01001_001"] -
      kcpop$hispanic$estimate[kcpop$hispanic$variable == "B01001I_001"]
  ),
  kc_total = kcpop$total
)
```

Find the percentage of each Hispanic origin category in KC sampled.

```{r}
mhsmry$hispanic_origin <- df |>
  left_join(
    kcpop$hispanic,
    by = c("hispanic_origin" = "hispanic_origin_acs"),
    keep = TRUE # preserve join var as factor
  ) |>
  select(-hispanic_origin_acs) |>
  mutate(pct_kc = pct(estimate, kc_total, 5))

mhsmry$hispanic_origin
```

### HOI regions

Summarize survey sample by HOI region.

```{r}
mhsurv |>
  count(hoi_region, .drop = FALSE)
```

### ZCTA

Pull the ACS population estimates by ZCTA for Kansas City.

```{r}
kcpop$zcta <- acs5_zcta_2023 |>
  filter(variable == "B01001_001") |>
  select(GEOID, estimate) |>
  mutate(kc_total = kcpop$total)
```

Find the percentage of each ZCTA population in KC sampled.

```{r}
mhsmry$zip <- mhsurv |>
  summarize_results("zip", drop = FALSE, na_rm = FALSE) |>
  left_join(
    sf_zcta_2024 |>
      st_drop_geometry() |>
      select(GEOID20, kc_area_pct),
    by = c("zip" = "GEOID20"),
    keep = TRUE # preserve join var as factor
  ) |>
  left_join(
    kcpop$zcta,
    by = c("zip" = "GEOID"),
    keep = TRUE # preserve join var as factor
  ) |>
  select(-GEOID, -GEOID20) |>
  mutate(pct_kc = pct(estimate, kc_total, 5) * kc_area_pct / 100)

mhsmry$zip
```

### Age structure

```{r}
mhsmry$age_str <- mhsurv |>
  summarize_results("age1", "birth_sex") |>
  mutate(n = case_when(
    birth_sex == "Male" ~ -n,
    birth_sex == "Female" ~ n,
    .default = NA
  )) |>
  rename(age = age1)

mhsmry$age_str
```

# Plot

## Demographics

```{r}
mhfigs <- lapply(names(mhsmry), \(x) {
  df <- mhsmry[[x]]
  plot <- cb$viz$plot[cb$viz$var == x]
  cap <- cb$viz$caption[cb$viz$var == x]
  sampsize <- unique(df$total)
  if (is.na(cap)) {
    cap <- paste0("N = ", sampsize, ".")
  } else {
    cap <- paste0(cap, " N = ", sampsize, ".")
  }
  yaxis <- cb$viz$axis[cb$viz$var == x]

  if (plot == "bar") {
    df <- df |>
      mutate(label = paste0(round_ties_away(pct), "%")) |>
      mutate(fcolor = "#F04C43") |>
      mutate(fcolor = factor(fcolor, levels = unique(fcolor))) |>
      mutate(lpos = if_else(pct > max(pct) / 8, 1, 0)) |>
      mutate(lcolor = if_else(lpos == 1, "white", "black")) |>
      mutate(lnudge = max(pct) / 60) |>
      mutate(lnudge = if_else(lpos == 1, -lnudge, lnudge))
    
    if ("pct_kc" %in% colnames(df)) df <- add_seg_vars(df, "pct_kc", x)

    fig <- df |>
      ggplot(aes(
        x = pct,
        y = .data[[x]],
        label = label,
        fill = fcolor
      )) |>
      mh_barplot(
        legend = FALSE,
        bar_reverse = TRUE,
        base_font_size = 11
      ) +
      scale_fill_identity() +
      geom_text(
        aes(label = label, hjust = lpos),
        nudge_x = df$lnudge,
        size = 11,
        size.unit = "pt",
        color = df$lcolor,
        fontface = "bold"
      ) +
      scale_x_continuous(expand = c(0, NA)) +
      xlab("\nSample (%)") +
      ylab(paste0(yaxis, "\n")) +
      scale_y_discrete(labels = scales::label_wrap(16)) +
      theme(plot.margin = margin(t = 50, b = 50, r = 20, l = 20))
    
    # if ("pct_kc" %in% colnames(df)) fig <- fig + pop_segment()
  } else if (plot == "pyr") {
    rngmax <- max(abs(df$n), na.rm = TRUE) + 5
    rng <- c(-rngmax, rngmax)
    pal <- c("#318CCC", "#F04C43")

    df <- df |>
      mutate(
        label = abs(n),
        fcolor = pal[as.numeric(df$birth_sex)],
        lpos = if_else(birth_sex == "Female", 1, 0),
        lnudge = if_else(birth_sex == "Female", -2, 2)
      )
    
    fig <- df |>
      ggplot(aes(x = n, y = age, label = label, fill = fcolor)) |>
      mh_barplot(
        legend_title = FALSE,
        base_font_size = 11
      ) +
      scale_fill_identity(
        name = "Birth sex",
        labels = df$birth_sex,
        breaks = df$fcolor,
        guide = "legend"
      ) +
      geom_text(
        aes(label = label, hjust = lpos),
        nudge_x = df$lnudge,
        size = 11,
        size.unit = "pt",
        # color = df$lcolor,
        color = "white",
        fontface = "bold"
      ) +
      xlab("\nSample (n)") +
      ylab(paste0(yaxis, "\n")) +
      scale_x_continuous(labels = abs, limits = rng) +
      theme(
        panel.grid.major.y = element_line(color = "grey92"),
        legend.position = "bottom",
        plot.margin = margin(t = 50, b = 50, r = 20, l = 20)
      )
  }

  list(plot = fig, cap = cap)
})

names(mhfigs) <- names(mhsmry)
```

```{r results='asis', echo=FALSE}
dims <- list(
  age = list(h = 5, w = 6),
  race_ethnicity = list(h = 6, w = 6),
  zip = list(h = 20, w = 6),
  age_str = list(h = 6, w = 8)
)

for (i in 1:length(mhfigs)) {
  x = names(mhfigs)[i]
  nm <- cb$viz$title[cb$viz$var == x]
  
  if (x %in% names(dims)) {
    h <- dims[[x]]$h; w <- dims[[x]]$w
  } else {
    h <- 4; w <- 6
  }
  
  chunk <- sprintf(
    "```{r %s, fig.height=%s, fig.width=%s}
    print(
      mhfigs[[i]]$plot |>
        add_caption(mhfigs[[i]]$cap, size = 15, width = 110)
    )
    ```",
    nm, h, w
  )

  print_md_text(paste("###", nm))
  print_md_chunk(chunk)
}
```

## Maps

### HOI regions

Map HOI regions and deidentified respondent residence locations.

```{r fig.width=4, fig.height=6}
ggplot() +
  geom_sf(
    data = sf_city_2023,
    fill = "pink",
    color = "red",
    linewidth = 1
  ) +
  geom_sf(
    data = hoi_regions,
    fill = "lightblue",
    color = "blue",
    linewidth = 1
  ) +
  geom_sf(
    data = mhsurv |>
      st_as_sf(coords = c("block_lon", "block_lat"), crs = 4326),
    color = "black",
    alpha = .5
  )
```

### Choropleth map

```{r}
geo_zcta <- st_transform(sf_zcta_2023, 4326)

kcpop$zcta <- acs5_zcta_2023 |>
  filter(grepl("^B01003", variable))
```

```{r}
pts <- mhsurv |>
  select(id, block_lon, block_lat) |>
  st_as_sf(
    coords = c("block_lon", "block_lat"),
    crs = 4326
  ) |>
  st_join(
    geo_zcta[, c("GEOID20", "geometry")],
    join = st_within
  ) |>
  count(GEOID20, .drop = FALSE) |>
  as.data.frame()
```

```{r}
geo_zcta <- geo_zcta |>
  left_join(
    pts[, c("GEOID20", "n")],
    by = "GEOID20"
  ) |>
  left_join(
    kcpop$zcta[, c("GEOID", "estimate")],
    by = c("GEOID20" = "GEOID")
  ) |>
  rename(n_sampled = n)
```

```{r}
geo_zcta <- geo_zcta |>
  mutate(kcpop = kc_area_pct / 100 * estimate) |>
  mutate(pct_sampled = setmeup::pct(n_sampled, kcpop, 8)) |>
  mutate(n_sampled_per_1k = n_sampled * 1000 / kcpop)
```

```{r fig.width=5, fig.height=6}
ggplot(geo_zcta) +
  geom_sf(
    aes(fill = n_sampled_per_1k)
  ) +
  theme_void() +
  scale_fill_viridis_c(
    breaks = c(0, 2, 4, 6, 8),
    name = "Number sampled per\n1,000 residents"
  )
```

### Sample points

Map of survey sample with OSM base layer and city boundary.

```{r}
geo_kc <- st_transform(sf_city_2024, crs = st_crs(3857))
ext <- st_bbox(geo_kc)
exp <- 5000
ext[1] <- ext[1] - exp
ext[2] <- ext[2] - exp
ext[3] <- ext[3] + exp
ext[4] <- ext[4] + exp
```

```{r}
pts <- st_transform(
  mhsurv |>
    select(block_lon, block_lat) |>
    st_as_sf(coords = c("block_lon", "block_lat"), crs = 4326),
  crs = st_crs(3857)
)
```

```{r fig.width=4, fig.height=6}
mhfigs$sample_map$plot <- ggplot(data = geo_kc) +
  basemaps::basemap_gglayer(
    ext = ext,
    map_service = "osm",
    map_type = "streets",
    map_res = 1,
    verbose = FALSE
  ) +
  geom_sf(
    data = geo_kc,
    color = NA,
    fill = "navy",
    alpha = .2
  ) +
  geom_sf(
    data = pts,
    color = "#ccc",
    fill = "navy",
    shape = 21,
    size = 2
  ) +
  scale_fill_identity() +
  coord_sf() +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  theme_void()

mhfigs$sample_map$cap <- paste0(
  "Approximate locations of Mental Health Survey respondents. N = 648."
)

mhfigs$sample_map$plot
```

# Save

```{r}
mhfigs_save <- mhfigs[!grepl("zip", names(mhfigs))]

saveRDS(mhfigs_save, "../data/2-final/figures_sample.rds")
```
