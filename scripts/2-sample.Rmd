---
title: "Survey sample characteristics"
output:
  html_notebook:
    css: "style.css"
---

# Purpose

Summarize the demographic and geographic characteristics of the Mental Health Survey sample, and compare the demographic and geographic profile of the survey sample to census population estimates for Kansas City.

# Set up environment and import data

```{r setup}
knitr::opts_chunk$set(
  dev = "png"
)

knitr::opts_knit$set(
  progress = FALSE,
  verbose = FALSE
)
```

```{r message=FALSE}
library(tidyverse)
library(readxl)
library(kcData)
library(setmeup)
library(sf)
library(gt, exclude = "pct")
```

```{r include=FALSE}
lapply(list.files(pattern = "^fn"), source)
```

```{r}
mhsurv <- readRDS("../data/2-final/mh_survey_results.rds")
cb <- readRDS("../data/2-final/mhs_codebook.rds")
hoi_regions <- st_read("../data/1-source/hoi_regions.shp", quiet = TRUE)
```

# Summarize

The survey was completed by 648 residents. Citywide population estimates were taken from the 2023 5-Year American Community Survey conducted by the US Census Bureau.

```{r}
demo <- list()
geo <- list()
```

## Birth sex

Summarize the survey sample by sex.

```{r}
df <- mhsurv |>
  summarize_results(var = "birth_sex", na_rm = TRUE)
```

Pull the ACS population estimates by sex for Kansas City.

```{r}
poptotal <- acs1_city_2023 |>
  filter(variable == "B01001_001") |>
  pull(estimate)

popsex <- acs1_city_2023 |>
  filter(variable %in% c("B01001_002", "B01001_026")) |>
  mutate(kc_total = poptotal)
```

Find the percentage of each sex category in KC sampled.

```{r}
demo$birth_sex <- df |>
  left_join(
    popsex |>
      select(label, estimate, kc_total) |>
      mutate(label = str_remove_all(label, "Estimate|Total|[:punct:]")),
    by = c("birth_sex" = "label"),
    keep = TRUE # keeps `birth_sex` as factor
  ) |>
  select(-label) |>
  mutate(
    pct_kc = pct(estimate, kc_total, 5),
    pct_fmt_kc = pct(estimate, kc_total, format = TRUE)
  )

demo$birth_sex
```

## Age

Summarize the survey sample by age.

```{r}
df <- mhsurv |>
  summarize_results(var = "age1", na_rm = TRUE)
```

Pull the ACS population estimates by age for Kansas City.

```{r}
p <- paste0("(", paste(18:100, collapse = "|"), ").*years")

popage <- acs1_city_2023 |>
  filter(
    str_detect(label, p),
    concept == "Sex by Age"
  ) |>
  mutate(kc_total = poptotal)
```

Summarize ACS estimates by the same age categories in the survey sample.

```{r}
popage <- popage |>
  select(label, estimate, kc_total) |>
  mutate(label = str_remove_all(label, "Estimate|Total|[:punct:]")) |>
  mutate(
    sex = str_extract(label, "^[:alpha:]+(?=\\d)"),
    age_group = str_extract(label, "\\d.*") |>
      str_remove("\\syears.*")
  )

rng <- list(18:34, 35:44, 45:54, 55:64, 65:74, 75:85)

popage <- data.frame(
  age = cb$age1$value,
  estimate = unlist(lapply(rng, \(x) {
    popage |>
      filter(str_detect(age_group, paste(x, collapse = "|"))) |>
      pull(estimate) |>
      sum()
  })),
  kc_total = unique(popage$kc_total)
)
```

Find the percentage of each age category in KC sampled.

```{r}
demo$age <- df |>
  rename(age = age1) |>
  left_join(
    popage,
    by = "age"
  ) |>
  mutate(
    pct_kc = pct(estimate, kc_total, 5),
    pct_fmt_kc = pct(estimate, kc_total)
  )

demo$age
```

## Age structure

```{r}
demo$age_str <- mhsurv |>
  summarize_results("age1", "birth_sex") |>
  mutate(n = case_when(
    birth_sex == "Female" ~ -n,
    birth_sex == "Male" ~ n,
    .default = NA
  )) |>
  rename(age = age1)

demo$age_str
```

## Race/ethnicity

### All categories

Summarize the survey sample by all race/ethnicity options.

```{r}
# Get total number of responses
t <- sum(!is.na(mhsurv$re_full))

# Split multiple selections into separate columns
df <- mhsurv |>
  select(re_full) |>
  separate_wider_delim(
    re_full,
    delim = "; ",
    names_sep = "_",
    too_few = "align_start"
  )

# Stack columns and summarize
df <- df |>
  stack(select = colnames(df)) |>
  select(race_ethnicity = values) |>
  drop_na() |>
  count(race_ethnicity, .drop = FALSE) |>
  mutate(total = t) |>
  mutate(
    pct = pct(n, total, 5),
    pct_fmt = pct(n, total, format = TRUE)
  ) |>
  mutate(race_ethnicity = str_remove(race_ethnicity, "\\s\\(.*$"))
```

```{r}
# Convert to factor sorted by size
lvl <- df |>
  arrange(pct) |>
  pull(race_ethnicity)

demo$race_ethnicity <- df |>
  mutate(race_ethnicity = factor(race_ethnicity, levels = lvl))

demo$race_ethnicity
```

Summarize the write-in responses for "Other".

```{r}
mhsurv |>
  count(re_other, .drop = FALSE)
```

### Collapsed categories

Summarize the survey sample by collapsed race/ethnicity categories.

```{r}
df <- mhsurv |>
  summarize_results(var = "re_bwo", na_rm = TRUE)
```

```{r}
# Convert to factor sorted by size
lvl <- df |>
  arrange(pct) |>
  pull(re_bwo)

df <- df |>
  mutate(re_bwo = factor(re_bwo, levels = lvl))
```

Pull the ACS population estimates by race for Kansas City.

```{r}
poprace <- acs1_city_2023 |>
  filter(grepl("B01001[A-G]_001", variable)) |>
  mutate(kc_total = poptotal)
```

Sum of estimates by race vs. total population estimate.

```{r}
data.frame(
  measure = c("Sum of race groups", "Total population"),
  estimate = c(
    poprace |>
      pull(estimate) |>
      sum(),
    poptotal
  )
)
```

Summarize the ACS population estimates by the collapsed race/ethnicity categories.

```{r}
popbwo <- data.frame(
  race = c("Black", "White", "Other"),
  estimate = c(
    poprace$estimate[grepl("Black", poprace$concept)],
    poprace$estimate[grepl("White", poprace$concept)],
    sum(poprace$estimate[!grepl("Black|White", poprace$concept)])
  ),
  kc_total = poptotal
)
```

Find the percentage of each collapsed race/ethnicity category in KC sampled.

```{r}
df <- df |>
  left_join(
    popbwo,
    by = c("re_bwo" = "race"),
    keep = TRUE # keeps `re_bwo` as factor
  ) |>
  select(-race) |>
  mutate(
    pct_kc = pct(estimate, kc_total, 5),
    pct_fmt_kc = pct(estimate, kc_total, format = TRUE)
  ) |>
  rename(race_collapsed = re_bwo)
```

```{r}
# Convert to factor
df <- df |>
  mutate(race_collapsed = factor(
    race_collapsed,
    levels = c("Black", "White", "Other"))
  )

df
```

Prep for plotting.

```{r}
lvl <- c("Survey respondents", "Kansas City population")

demo$race_collapsed <- df |>
  select(
    race_collapsed,
    pct_srvy = pct, pct_kc,
    pctfmt_srvy = pct_fmt, pctfmt_kc = pct_fmt_kc
  ) |>
  pivot_longer(
    cols = !race_collapsed,
    names_to = c(".value", "pop"),
    names_sep = "_"
  ) |>
  mutate(pop = case_when(
    pop == "srvy" ~ lvl[1],
    pop == "kc" ~ lvl[2]
  )) |>
  mutate(
    pop = factor(pop, levels = lvl),
    total = unique(df$total)
  ) |>
  rename(pct_fmt = pctfmt)

demo$race_collapsed
```

## Hispanic origin

Summarize the survey sample by Hispanic origin.

```{r}
df <- mhsurv |>
  summarize_results(var = "hispanic_origin", na_rm = TRUE)
```

Pull the ACS population estimate by Hispanic origin for Kansas City and summarize.

```{r}
pophisp <- acs1_city_2023 |>
  filter(grepl("B01001I_001", variable)) |>
  mutate(kc_total = poptotal) |>
  pull(estimate)

pophisp <- data.frame(
  hispanic_origin_acs = c("Hispanic", "Not Hispanic"),
  estimate = c(
    pophisp,
    poptotal - pophisp
  ),
  kc_total = poptotal
)
```

Find the percentage of each Hispanic origin category in KC sampled.

```{r}
df <- df |>
  left_join(
    pophisp,
    by = c("hispanic_origin" = "hispanic_origin_acs"),
    keep = TRUE # preserve join var as factor
  ) |>
  select(-hispanic_origin_acs) |>
  mutate(
    pct_kc = pct(estimate, kc_total, 5),
    pct_fmt_kc = pct(estimate, kc_total, format = TRUE)
  )

df
```

Prep for plotting.

```{r}
lvl <- c("Survey respondents", "Kansas City population")

demo$hispanic_origin <- df |>
  select(
    hispanic_origin,
    pct_srvy = pct, pct_kc,
    pctfmt_srvy = pct_fmt, pctfmt_kc = pct_fmt_kc
  ) |>
  pivot_longer(
    cols = !hispanic_origin,
    names_to = c(".value", "pop"),
    names_sep = "_"
  ) |>
  mutate(pop = case_when(
    pop == "srvy" ~ lvl[1],
    pop == "kc" ~ lvl[2]
  )) |>
  mutate(
    pop = factor(pop, levels = lvl),
    total = unique(df$total)
  ) |>
  rename(pct_fmt = pctfmt)

demo$hispanic_origin
```

## HOI regions

Summarize survey sample by HOI region.

```{r}
mhsurv |>
  count(hoi_region, .drop = FALSE)
```

## ZCTA

Pull the ACS population estimates by ZCTA for Kansas City.

```{r}
popzcta <- acs5_zcta_2023 |>
  filter(variable == "B01001_001") |>
  select(GEOID, estimate) |>
  mutate(kc_total = poptotal)
```

Find the percentage of each ZCTA population in KC sampled.

```{r}
geo$zip <- mhsurv |>
  summarize_results("zip", drop = FALSE, na_rm = FALSE) |>
  left_join(
    sf_zcta_2024 |>
      st_drop_geometry() |>
      select(GEOID20, kc_area_pct),
    by = c("zip" = "GEOID20"),
    keep = TRUE # preserve join var as factor
  ) |>
  left_join(
    popzcta,
    by = c("zip" = "GEOID"),
    keep = TRUE # preserve join var as factor
  ) |>
  select(-GEOID, -GEOID20) |>
  mutate(pct_kc = pct(estimate, kc_total, 5) * kc_area_pct / 100)

geo$zip
```

```{r}
geo$zip |>
  filter(kc_area_pct >= 20, estimate >= 1100)
```

## Council district

```{r}
geo$district <- mhsurv |>
  group_by(district) |>
  summarize(count = n())

geo$district
```

# Plot/viz

## Demographics

```{r}
figs <- imap(demo, \(df, x) plot_sample(df, x))
names(figs) <- names(demo)

caps <- imap(demo, \(df, x) cap_text(df, x))
names(caps) <- names(demo)
```

```{r fig.width=3, fig.height=3}
figs$birth_sex
```

```{r fig.width=5, fig.height=3}
figs$age
```

```{r fig.width=6, fig.height=3}
figs$age_str
```

```{r fig.width=6, fig.height=4}
figs$race_ethnicity
```

```{r fig.width=6, fig.height=4}
figs$race_collapsed
```

```{r fig.width=4.5, fig.height=4}
figs$hispanic_origin
```

## Maps

### HOI regions

Map HOI regions and deidentified respondent residence locations.

```{r fig.width=4, fig.height=6}
ggplot() +
  geom_sf(
    data = sf_city_2023,
    fill = "pink",
    color = "red",
    linewidth = 1
  ) +
  geom_sf(
    data = hoi_regions,
    fill = "lightblue",
    color = "blue",
    linewidth = 1
  ) +
  geom_sf(
    data = mhsurv |>
      st_as_sf(coords = c("block_lon", "block_lat"), crs = 4326),
    color = "black",
    alpha = .5
  )
```

### Choropleth map

```{r}
geo_zcta <- st_transform(sf_zcta_2023, 4326)

popzcta <- acs5_zcta_2023 |>
  filter(grepl("^B01003", variable))
```

```{r}
pts <- mhsurv |>
  select(id, block_lon, block_lat) |>
  st_as_sf(
    coords = c("block_lon", "block_lat"),
    crs = 4326
  ) |>
  st_join(
    geo_zcta[, c("GEOID20", "geometry")],
    join = st_within
  ) |>
  count(GEOID20, .drop = FALSE) |>
  as.data.frame()
```

```{r}
geo_zcta <- geo_zcta |>
  left_join(
    pts[, c("GEOID20", "n")],
    by = "GEOID20"
  ) |>
  left_join(
    popzcta[, c("GEOID", "estimate")],
    by = c("GEOID20" = "GEOID")
  ) |>
  rename(n_sampled = n)
```

```{r}
geo_zcta <- geo_zcta |>
  mutate(kcpop = kc_area_pct / 100 * estimate) |>
  mutate(pct_sampled = setmeup::pct(n_sampled, kcpop, 8)) |>
  mutate(n_sampled_per_1k = n_sampled * 1000 / kcpop)
```

```{r fig.width=5, fig.height=6}
ggplot(geo_zcta) +
  geom_sf(
    aes(fill = n_sampled_per_1k)
  ) +
  theme_void() +
  scale_fill_viridis_c(
    breaks = c(0, 2, 4, 6, 8),
    name = "Number sampled per\n1,000 residents"
  )
```

### Respondent locations

Map of survey sample with OSM base layer and city boundary.

```{r}
geo_kc <- st_transform(sf_city_2024, crs = st_crs(3857))
ext <- st_bbox(geo_kc)
exp <- 1000
ext[1] <- ext[1] - exp
ext[2] <- ext[2] - exp
ext[3] <- ext[3] + exp
ext[4] <- ext[4] + exp
```

```{r}
pts <- st_transform(
  mhsurv |>
    select(block_lon, block_lat) |>
    st_as_sf(coords = c("block_lon", "block_lat"), crs = 4326),
  crs = st_crs(3857)
)
```

```{r fig.width=4, fig.height=6}
figs$map_respondents <- ggplot(data = geo_kc) +
  basemaps::basemap_gglayer(
    ext = ext,
    map_service = "osm",
    map_type = "streets",
    map_res = 1,
    verbose = FALSE
  ) +
  geom_sf(
    data = geo_kc,
    color = NA,
    fill = "navy",
    alpha = .2
  ) +
  geom_sf(
    data = pts,
    color = "#ccc",
    fill = "navy",
    shape = 21,
    size = 2
  ) +
  scale_fill_identity() +
  coord_sf() +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  theme_void()

caps$map_respondents <- paste0(
  "Approximate locations of Mental Health Survey respondents. N = 648."
)

figs$map_respondents
```

## Tables

```{r}
tbl_dist <- geo$district |>
  gt() |>
  cols_label(
    district = "Council district",
    count = "Number of respondents"
  )

caps$tbl_dist <- "Survey respondents by council district"

tbl_dist
```

# Save

```{r}
dir.create("report/img", showWarnings = FALSE)
```

```{r}
ggsave(
  "report/img/map-respondents.png", figs$map_respondents,
  height = 6, dpi = 100
)

ggsave(
  "report/img/demo-sex.png", figs$birth_sex,
  width = 3, height = 3, dpi = 100
)

ggsave(
  "report/img/demo-age.png", figs$age,
  width = 5, height = 3, dpi = 100
)

ggsave(
  "report/img/demo-age-str.png", figs$age_str,
  width = 6, height = 3, dpi = 100
)

ggsave(
  "report/img/demo-race-eth.png", figs$race_ethnicity,
  width = 6, height = 4, dpi = 100
)

ggsave(
  "report/img/demo-race-col.png", figs$race_collapsed,
  width = 6, height = 4, dpi = 100
)

ggsave(
  "report/img/demo-hisp.png", figs$hispanic_origin,
  width = 4.5, height = 4, dpi = 100
)

gtsave(tbl_dist, "report/img/tbl-dist.png")
```

```{r}
saveRDS(caps, "../data/2-final/figure_captions_sample.rds")
```
